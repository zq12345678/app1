# 语音识别问题修复说明

## 问题诊断

### 错误信息
根据提供的错误截图：
- **错误代码**: 400
- **错误信息**: Invalid recognition 'config': bad encoding..
- **状态**: INVALID_ARGUMENT

### 根本原因

通过分析代码和 Git 历史记录，发现问题的根本原因是：

1. **音频编码格式不匹配**
   - 原代码使用 `.m4a` 格式（AAC 编码）录制音频
   - Google Speech-to-Text API **不支持 AAC/M4A 格式**
   - API 配置中缺少明确的 `encoding` 参数，导致 Google 无法识别音频格式

2. **Google Speech-to-Text API 支持的格式**
   - LINEAR16 (PCM WAV) ✅
   - FLAC ✅
   - MULAW ✅
   - AMR / AMR_WB ✅
   - OGG_OPUS ✅
   - WEBM_OPUS ✅
   - AAC / M4A ❌ **不支持**

3. **历史尝试记录**
   - 最初使用 `AMR_WB` 编码 → 失败
   - 改为 `LINEAR16` 但录音仍是 M4A 格式 → 失败
   - 移除编码配置让 Google 自动检测 → 失败（截图中的错误）
   - 最后放弃，改为模拟转录

## 修复方案

### 核心修改

修改了 `contexts/RecordingContext.js` 文件，主要包括：

1. **添加 expo-file-system 导入**
   ```javascript
   import * as FileSystem from 'expo-file-system';
   ```

2. **修改录音配置为 LINEAR16 (PCM WAV) 格式**
   ```javascript
   const recordingOptions = {
       android: {
           extension: '.wav',
           outputFormat: Audio.AndroidOutputFormat.DEFAULT,
           audioEncoder: Audio.AndroidAudioEncoder.DEFAULT,
           sampleRate: 16000,
           numberOfChannels: 1,
           bitRate: 128000,
       },
       ios: {
           extension: '.wav',
           outputFormat: Audio.IOSOutputFormat.LINEARPCM,
           audioQuality: Audio.IOSAudioQuality.HIGH,
           sampleRate: 16000,
           numberOfChannels: 1,
           bitRate: 128000,
           linearPCMBitDepth: 16,
           linearPCMIsBigEndian: false,
           linearPCMIsFloat: false,
       },
   };
   ```

3. **恢复真实的 Google Speech-to-Text API 调用**
   - 使用 `FileSystem.readAsStringAsync` 读取音频文件并转换为 base64
   - 在 API 配置中明确指定 `encoding: 'LINEAR16'`
   - 添加完善的错误处理和用户提示

4. **API 请求配置**
   ```javascript
   config: {
       encoding: 'LINEAR16',  // 明确指定 LINEAR16 编码
       sampleRateHertz: 16000,
       languageCode: 'zh-CN',
       alternativeLanguageCodes: ['en-US', 'zh-TW'],
       enableAutomaticPunctuation: true,
   }
   ```

## 验证步骤

### 1. 确认依赖已安装
项目已包含必要的依赖：
- ✅ `expo-av` (v16.0.7)
- ✅ `expo-file-system` (v19.0.19)

### 2. 测试语音识别功能

1. **启动应用**
   ```bash
   cd /Users/edricz/Downloads/appVer1
   npm start
   ```

2. **进入笔记详情页面**
   - 打开任意文件夹
   - 选择任意讲座
   - 进入笔记详情页面

3. **测试录音**
   - 点击底部的麦克风按钮开始录音
   - 清晰地说一段话（中文或英文）
   - 再次点击按钮停止录音
   - 等待处理（会显示 "Transcribing..." 提示）

4. **验证结果**
   - 成功：识别的文本会出现在笔记列表中
   - 失败：会显示详细的错误信息

### 3. 可能的错误情况

如果仍然出现错误，请检查：

1. **API 密钥是否有效**
   - 检查 `config/api.js` 中的 `GOOGLE_API_KEY`
   - 确认 API 密钥已启用 Speech-to-Text API
   - 检查 API 配额是否用尽

2. **网络连接**
   - 确保设备可以访问 Google API
   - 检查防火墙设置

3. **录音权限**
   - 确保应用已获得麦克风权限
   - iOS: 设置 → 隐私 → 麦克风
   - Android: 设置 → 应用 → 权限

4. **录音质量**
   - 确保录音时间足够长（至少 1-2 秒）
   - 避免环境噪音过大
   - 说话要清晰

## 技术细节

### 为什么选择 LINEAR16 格式？

1. **兼容性最好**: Google Speech-to-Text API 完全支持
2. **无损音质**: PCM 是未压缩格式，识别准确度高
3. **跨平台支持**: iOS 和 Android 都原生支持
4. **配置简单**: 不需要复杂的编码转换

### 音频参数说明

- **sampleRate: 16000**: 16kHz 采样率，语音识别的标准配置
- **numberOfChannels: 1**: 单声道，减少文件大小
- **linearPCMBitDepth: 16**: 16位深度，平衡音质和文件大小

## 后续优化建议

1. **添加多语言翻译**
   - 当前识别结果在所有语言字段中都是相同的
   - 可以集成 Google Translation API 实现真实翻译

2. **优化用户体验**
   - 添加录音波形显示
   - 显示录音时长
   - 添加录音音量指示器

3. **错误处理增强**
   - 添加网络状态检测
   - 实现离线缓存机制
   - 添加重试功能

4. **性能优化**
   - 对于长录音，考虑分段处理
   - 添加音频压缩（在保证识别准确度的前提下）

## 修改文件清单

- ✅ `contexts/RecordingContext.js` - 主要修复文件
- ✅ `语音识别修复说明.md` - 本文档

## 联系支持

如果问题仍然存在，请提供：
1. 完整的错误日志（控制台输出）
2. 使用的设备和操作系统版本
3. 录音时长和内容
4. API 响应的完整 JSON（如果有）

